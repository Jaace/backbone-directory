/*! backbone_ Directory - v0.1.0
 * http://wordpress.org/plugins
 * Copyright (c) 2014; * Licensed GPLv2+ */
window.wp=window.wp||{},function(e){e(document).ready(function(){var n=Backbone.Model.extend({initialize:function(e){void 0!==e&&this.set({name:e.name,emailhash:e.emailhash,twitterurl:e.twitterurl,twittertxt:e.twittertxt,atendeeUrl:e.atendeeUrl})}}),o=Backbone.Collection.extend({columnNames:null,search:"",setup:function(e){this.columnNames=e},searchFor:function(e){console.log("backbone_personCollection:search "),this.search=e,this.trigger("change")}}),t=Backbone.View.extend({template:wp.template("backbone_person"),el:"#backbone_card",initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.attributes)),this}}),i=Backbone.View.extend({template:wp.template("backbone_person_detail"),el:"#backbone_card_detail_container",model:null,initialize:function(n){var o=this;this.backboneGrid=n.backboneGrid,this.backbonePeople=n.backbonePeople,this.backboneRouter=n.backboneRouter,this.listenTo(this.backboneGrid,"detailView",this.personDetail),e(document).on("keyup",_.throttle(function(e){o.keyPress(e)},250))},personDetail:function(n){console.log("personDetail");var o=e(n.currentTarget),t=o.find(".backbone_person-name>span").text();this.model=this.backbonePeople.findWhere({title:t}),this.render()},showPersonDetailDialog:function(){this.$el.is(":hidden")&&this.$el.fadeIn()},hidePersonDetailDialog:function(){this.$el.fadeOut("fast")},getCurrentIndex:function(){return this.backbonePeople.indexOf(this.model)},goPrevious:function(){this.hasPrevious()&&(this.model=this.backbonePeople.at(this.backbonePeople.indexOf(this.model)-1),this.render())},hasPrevious:function(){return this.getCurrentIndex()-1>-1},goNext:function(){this.hasNext()&&(this.model=this.backbonePeople.at(this.getCurrentIndex()+1),this.render())},hasNext:function(){return this.getCurrentIndex()+1<this.backbonePeople.length},keyPress:function(n){return console.log("keypress"),27===n.keyCode?(this.hidePersonDetailDialog(),n):((13===n.keyCode||32===n.keyCode)&&e(n.target).trigger("click"),this.$el.is(":hidden")||(39===n.keyCode&&_.once(this.goNext()),37===n.keyCode&&_.once(this.goPrevious())),void 0)},render:function(){return this.backboneRouter.navigate("?details="+this.model.get("name"),{replace:!1}),console.log("BackbonePersonDetail render "),this.$el.html(this.template(this.model.attributes)),this.showPersonDetailDialog(),this}}),a=Backbone.View.extend({backbonePeople:null,self:this,el:"#backbone_search",template:wp.template("backbone_person-search"),search:"",initialize:function(e){var n=this;e.backboneRouter,console.log("backbone_Searchbar.initialize "),this.backbonePeople=e.backbonePeople,this.render(),this.$el.on("keypress","#backbone_person-search-field",_.debounce(function(){n.searchChange(this)},250))},events:{"keypress #backbone_person-search-field":"searchChange"},searchChange:function(e){var n=this.$el.find(e).prop("value");console.log("searchchange "+n),this.backbonePeople.searchFor(n)},render:function(){console.log("backbone_Searchbar:render ");var e=this.template(this.search);return this.$el.html(e),this}}),r=Backbone.View.extend({backbonePeople:null,el:"#backbone_grid",msnry:null,template:wp.template("backbone_person"),events:{"click .backbone_person-card":"clickackbonePerson"},clickackbonePerson:function(e){console.log("triggering personDetail"),this.trigger("detailView",e)},initialize:function(e){console.log("BackboneGrid.initialize"),this.backbonePeople=e.backbonePeople,this.backboneRouter=e.backboneRouter,this.listenTo(this.backbonePeople,"change",this.searchChanged)},searchChanged:function(){_.debounce(this.adjustSearch(),250)},adjustSearch:function(){if(console.log("backbone_Grid:searchChanged"),void 0!==this.backbonePeople.search){var e=""===this.backbonePeople.search?"":"?search="+this.backbonePeople.search;this.backboneRouter.navigate(e,{replace:!1}),this.render()}},render:function(){var e,n=this,o=this.backbonePeople.search.toLowerCase();console.log("backbone_Grid:render "),e=""===o?this.backbonePeople.models:_.filter(this.backbonePeople.models,function(e){return-1!==e.get("name").toLowerCase().indexOf(o)});var t="";n.$el.html(""),_.each(e,function(e){t+=n.template(e.attributes)}),n.$el.html(t),console.log(" gridrender complete "),n.$el.parent().find("#backbone-person-count>span").html(e.length)}}),s=Backbone.Router.extend({routes:{"?details=:name":"openbackbonePerson","?search=:search":"performSearch"},baseURL:function(){return window.location.pathname},openbackbonePerson:function(e){console.log("route: "+e+" "),c.personDetail.model=c.backbonePeople.where({name:e})[0],c.personDetail.render()},performSearch:function(n){console.log("Router::performSearch"),e("input#backbone_person-search-field").val(n).trigger("keypress").select(),c.personDetail.hidePersonDetailDialog()}}),c={initialize:function(){var c,l=this;e("#backbone_directory_loading_count"),l.backbonePeople=new o,l.backbonePeople.url="/wp-json/posts?filter[posts_per_page]=1000&filter[order]=ASC&filter[offset]=22&type=backbonedirectory",c=l.backbonePeople.fetch(),c.done(function(e){console.log(e),l.backboneRouter=new s,l.backbonePersonDisp=new t({model:new n});var o={backbonePeople:l.backbonePeople,backboneRouter:l.backboneRouter};l.backboneGrid=new r(o),new a(o),l.personDetail=new i(_.extend(o,{backboneGrid:l.backboneGrid,model:new n})),l.backboneGrid.render()}),e(window).on("resize",_.debounce(function(){var n=e(this).innerWidth()-10;e("#backbone_grid-container").height("100%"),e("#backbone_grid-container").width(n+"px")},150)),Backbone.history.start({pushState:!0,root:window.location.pathname})}};c.initialize()})}(jQuery);